<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf8"></meta>
  </head>
  <script>
    const positionOptions = [
      {
        positionId: "ai",
        title: "AI演算法工程師",
      },
      {
        positionId: "pythonbackend",
        title: "Python後端軟體工程師",
      },
      {
        positionId: "frontend",
        title: "前端工程師",
      },
    ];
    const scoreForm = [
      {
        groupId: "python",
        positionIds: ["pythonbackend", "ai"],
        title: "Python能力",
        items: [
          {
            itemId: "syntax",
            title: "語法熟悉度 (built-in types, decorator, …)",
            positionIds: null,
          },
          {
            itemId: "concept",
            title: "Python運作原理 (async, multi-thread, multi-processing, garbage collection, …)",
            positionIds: null,
          },
          {
            itemId: "package",
            title: "套件使用 (torch, pandas, scikit-learn, celery, FastAPI…)",
            positionIds: null,
          },
        ],
      },
      {
        groupId: "prof",
        title: "專業能力",
        positionIds: null,
        items: [
          {
            itemId: "devflow",
            title: "開發流程管理 (Git, CI/CD, Docker, test)",
            positionIds: null,
          },
          {
            itemId: "network",
            title: "網路概念 (HTTP methods, RESTful API, CORS, attacks)",
            positionIds: ["frontend", "pythonbackend"],
          },
          {
            itemId: "database",
            title: "資料庫使用經驗及能力 (SQL, NoSQL, vector store)",
            positionIds: ["pythonbackend", "ai"],
          },
          {
            itemId: "frontend",
            title: "前端語言能力 (JQuery, VueJS, RWD, CSS)",
            positionIds: ["frontend"],
          },
          {
            itemId: "dataproc",
            title: "處理資料能力 (data leakage, pre-/post-processing, cross validation)",
            positionIds: ["ai"],
          },
          {
            itemId: "dataexp",
            title: "處理資料經驗 (tabular, image, stream, language, audio, medical, …)",
            positionIds: ["frontend", "pythonbackend", "ai"],
          },
          {
            itemId: "aimodel",
            title: "AI 模型能力 (ensemble, training)",
            positionIds: ["ai"],
          },
        ],
      },
      {
        groupId: "project",
        positionIds: null,
        title: "專案實作經驗",
        items: [
          {
            itemId: "backendproj",
            title: "後端專案",
            positionIds: ["pythonbackend"],
          },
          {
            itemId: "frontendproj",
            title: "前端專案",
            positionIds: ["frontend"],
          },
          {
            itemId: "aiproj",
            title: "AI 專案",
            positionIds: ["ai"],
          },
        ]
      },
      {
        groupId: "other",
        positionIds: null,
        title: "其他",
        items: [
          {
            itemId: "biobackground",
            title: "生物醫療背景知識",
            positionIds: null,
          },
          {
            itemId: "positivity",
            title: "積極度",
            positionIds: null,
          },
          {
            itemId: "solv",
            title: "解決問題及組織能力",
            positionIds: null,
          },
          {
            itemId: "communication",
            title: "理解及溝通表能力",
            positionIds: null,
          },
        ],
      }
    ];
  </script>
  <body>
    <h2>面試紀錄表</h2>
    <span id="butGroup">
      <form action="">
        <button id="butEdit" hidden>啟用編輯</button>
        <button id="butSave">另存 HTML 檔</button>
        <button id="butPrint">列印</button>
      </form>
    </span>
    <h2>基本資料</h2>
    <form id="info">
      <div><label for="name">應徵者姓名</label><input id="name" type="text"></div>
      <div><label for="time">面試時間</label><input id="time" type="datetime-local"></div>
      <div>
        <label for="position">面試職位</label>
        <span>
          <select id="position" name="position" value="">
            <option value=""></option>
          </select>
          <label for="position-2">其他</label>
          <input id="position-2" type="text">
        </span>
      </div>
      <div><label for="iname">面試人員</label><input id="iname" type="text" data-fromstorage="true"></div>
    </form>
    <h2>
      檢核項目
      <form id="filter">
        <input type="checkbox" id='showUnscored' checked><label for="showUnscored">未評分項目</label>
        <input type="checkbox" id='showAllPositionUnrelated' disabled><label for="showAllPositionUnrelated">職位無關項目</label>
      </form>
    </h2>
    <form id="scoring"></form>
    <form id="record">
      <h2>面試紀錄</h2>
      <textarea id="面試紀錄" rows="30"></textarea>
    </form>
  </body>
  <script>
    // utils
    function createElement (tag, attrs=null, childNodes=null) {
      const elem = document.createElement(tag);
      if (attrs != null) {
        Object.entries(attrs).forEach(([attr, value]) => {
          if (value != null) elem.setAttribute(attr, value);
        });
      }
      if (childNodes != null) {
        childNodes.forEach((node) => {
          if (node != null) elem.append(node);
        });
      }
      return elem;
    }
    function createScoringItem (id, title, positionIds) {
      /*
      <div data-positionids="{positionIds.join(',')}">
        <label for="{id}">{title}</label>
        <span id="{id}">
          <input type="radio" name="{id}" checked><label>?</label>
          <input type="radio" name="{id}" value="0"><label>0</label>
          <input type="radio" name="{id}" value="1"><label>1</label>
          <input type="radio" name="{id}" value="2"><label>2</label>
          <input type="radio" name="{id}" value="3"><label>3</label>
          <input type="radio" name="{id}" value="4"><label>4</label>
          <input type="radio" name="{id}" value="5"><label>5</label>
          <textarea id="{id}-comment" name="" cols="50" rows="1"></textarea>
        </span>
      </div>
      */
      const elemOpts = createElement('span', {id: id}, [
        createElement('input', {type: 'radio', name: id, value: '?', checked: ''}),
        createElement('label', {}, ['?'])
      ]);
      for (let i=0; i<6; i++) {
        elemOpts.append(
          createElement('input', {type: 'radio', name: id, value: i}),
          createElement('label', {}, [i])
        );
      }
      elemOpts.append(createElement('textarea', {id: `${id}-comment`, name: "", cols: 50, rows: 1}));
      return createElement(
        'div',
        {'class': 'scoring-item', 'data-positionids': (positionIds??[]).join(',')},
        [createElement('label', {'for': id}, [title]), elemOpts],
      );
    }
    function getPositionId () {
      return document.getElementById('position')?.value || null;
    }
    function getPositionName () {
      const pos1 = document.getElementById('position')?.value;
      if (pos1) {
        return document.querySelector(`#position > option[value=${pos1}]`).innerHTML;
      } else {
        return document.getElementById('position-2').value;
      }
    }
    function setHideAllPositionUnrelated (hide) {
      hide = hide ?? !document.getElementById('showAllPositionUnrelated').checked;
      const positionId = getPositionId();
      document.querySelectorAll("[data-positionids]").forEach((elem) => {
        const positionIds = (elem.dataset['positionids']||null)?.split(',');
        const toHide = (
          hide && positionId != null && positionIds != null
            && !positionIds.includes(positionId)
        );
        toHide ? elem.setAttribute('hidden', '') : elem.removeAttribute('hidden');
      });
    }
    function setHideAllUnscored (hide) {
      hide = hide ?? !document.getElementById('showUnscored').checked;
      const positionId = getPositionId();
      document.querySelectorAll(".scoring-item").forEach((elem) => {
        const toHide = hide && elem.querySelectorAll("[checked]")[0].value == '?';
        toHide ? elem.setAttribute('hidden', '') : elem.removeAttribute('hidden');
      });
    }
    (function () {
      // position options
      const elemPositionSelect = document.getElementById('position');
      elemPositionSelect.append(...positionOptions.map((opt) => 
        createElement('option', {'value': opt.positionId}, [opt.title])
      ));
      // scoring form
      const elemScoreForm = document.getElementById('scoring');
      scoreForm.forEach((group) => {
        elemScoreForm.append(
          createElement('h3', {'data-positionids': group.positionIds}, [group.title]),
          ...group.items.map((groupItem) => 
            createScoringItem(groupItem.itemId, groupItem.title, groupItem.positionIds??group.positionIds)
          ),
        );
      });
    })();
  </script>
  <script>
    addEventListener("beforeunload", (event) => {});
    onbeforeunload = () => '';
    window.onload = () => {
      // default date
      const localStorage = window.localStorage;
      Date.prototype.toDateInputValue = (function() {
        var now = new Date();
        var offset = now.getTimezoneOffset() * 60000;
        var adjustedDate = new Date(now.getTime() - offset);
        return adjustedDate.toISOString().substring(0,16);
      }); 
      const timeElem = document.getElementById("time");
      if (!timeElem.value) {
        timeElem.value = new Date().toDateInputValue();
      }
      // default iname
      const inameElem = document.getElementById("iname")
      if (inameElem.dataset.fromstorage=="true") {
        inameElem.value = localStorage.getItem("MuenInterviewerName");
      }
      // events
      // iname change
      document.getElementById("iname").addEventListener("change", (e) => {
        const iname = e.target.value;
        localStorage.setItem("MuenInterviewerName", iname);
      });
      // pos change
      document.getElementById("position").addEventListener("change", (e) => {
        if (!!e.target.value) {
          document.getElementById("position-2").value = "";
          document.getElementById("showAllPositionUnrelated").removeAttribute('disabled');
          setHideAllPositionUnrelated();
        } else {
          document.getElementById("showAllPositionUnrelated").setAttribute('disabled', '');
          setHideAllPositionUnrelated(false);
        }
      });
      // pos2 input
      document.getElementById("position-2").addEventListener("input", (e) => {
        document.getElementById("position").value = "";
        document.getElementById("showAllPositionUnrelated").setAttribute('disabled', '');
        setHideAllPositionUnrelated(false);
      });
      // showAllPositionUnrelated
      setHideAllPositionUnrelated();
      document.getElementById("showAllPositionUnrelated").addEventListener("change", (e) => {
        setHideAllPositionUnrelated(!e.target.checked);
      });
      // hide unscored
      document.getElementById("showUnscored").addEventListener("change", (e) => {
        setHideAllUnscored(!e.target.checked);
      });
      // disable default form action
      const forms = document.getElementsByTagName("form");
      for (let form of forms) {
        form.addEventListener("submit", (e) => {e.preventDefault();}, false);
      }
      // edit button
      const butEdit = document.getElementById("butEdit");
      butEdit.addEventListener("click", (e) => {
        butEdit.setAttribute("hidden", true);
        for (let dom of document.querySelectorAll("input,textarea,select")) {
          dom.removeAttribute("disabled");
        }
      });
      // print button
      const butPrint = document.getElementById("butPrint");
      butPrint.addEventListener("click", (e) => {
        print();
      });
      // save button
      const butSave = document.getElementById("butSave");
      butSave.addEventListener("click", (e) => {
        if (!validateForm()) return;
        const name = document.getElementById("name").value;
        const time = document.getElementById("time").value;
        const posName = getPositionName();

        const match = /(\d{4})-(\d{2})-(\d{2})T(\d{2}):(\d{2})/.exec(time);
        const yyyy=match[1], mm=match[2], dd=match[3], h=match[4], m = match[5];
        const timestr = `${yyyy}${mm}${dd}_${h}${m}`
        const fname = `${posName}_${timestr}_${name}.html`;

        const html = handleFormValues();
        const htmlBlob = new Blob([html], { type: "text/html" });
        const blobUrl = URL.createObjectURL(htmlBlob);
        const anchorElement = document.createElement("a");
        anchorElement.href = blobUrl;
        anchorElement.download = fname;
        anchorElement.click();
      });
      // form
      function validateForm () {
        const name = document.getElementById("name").value;
        const iname = document.getElementById("iname").value;
        const pos1 = document.getElementById("position").value;
        const pos2 = document.getElementById("position-2").value;
        const pos = !!pos1 ? pos1 : pos2;
        if (!name) alert("應徵者姓名未填寫");
        else if (!pos) alert("面試職位未填寫");
        else if (!iname) alert("面試人員未填寫");
        else {
          return true;
        }
        return false;
      }
      function handleFormValues () {
        const butEdit = document.getElementById("butEdit");
        butEdit.removeAttribute("hidden");

        document.getElementById("iname").setAttribute("data-fromstorage", "false");
        for (let dom of document.querySelectorAll("input[type=text]")) {
          dom.setAttribute("value", dom.value)
          dom.setAttribute("disabled", true);
        }
        for (let dom of document.querySelectorAll("input[type=radio]")) {
          if (dom.checked) {
            dom.setAttribute("checked", "true");
          } else {
            dom.removeAttribute("checked");
          }
          dom.setAttribute("disabled", true);
        }
        for (let dom of document.querySelectorAll("select")) {
          dom.setAttribute("value", dom.value)
          dom.setAttribute("disabled", true);
          for (let opt of dom.children) {
            if (opt.selected) {
              opt.setAttribute("selected", "true")
            } else {
              opt.removeAttribute("selected")
            }
          }
        }
        for (let dom of document.querySelectorAll("input[type=datetime-local]")) {
          dom.setAttribute("value", dom.value)
          dom.setAttribute("disabled", true);
        }
        for (let dom of document.getElementsByTagName("textarea")) {
          dom.innerHTML = dom.value;
          dom.setAttribute("disabled", true);
        }
        const html = document.getElementsByTagName("html")[0].innerHTML;
        return html;
      }
    }
  </script>
  <style>
  label {
    margin-right: 5px;
  }
  form#filter {
    font-size: initial;
    font-weight: normal;
    display: inline-flex;
    align-items: center;
  }
  form#scoring {
    width: fit-content;
    margin-bottom: 5px;
  }
  form#scoring > div {
    display: flex;
    justify-content: space-between;
    margin-bottom: 5px;
  }
  textarea#面試紀錄 {
    width: 80vw;
  }
  #butGroup {
    display: block;
    position: absolute;
    right: 50px;
    top: 50px;
  }
  [hidden] {
    display: none !important;
  }
  </style>
</html>
