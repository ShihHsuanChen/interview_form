<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf8"></meta>
  </head>
  <script>
    const positionOptions = [
      {
        positionId: "ai",
        title: "AI演算法工程師",
      },
      {
        positionId: "pythonbackend",
        title: "Python後端軟體工程師",
      },
      {
        positionId: "frontend",
        title: "前端工程師",
      },
    ];
    const scoreForm = [
      {
        groupId: "python",
        positionIds: ["pythonbackend", "ai"],
        title: "Python能力",
        items: [
          {
            itemId: "syntax",
            title: "語法熟悉度 (built-in types, decorator, …)",
            positionIds: null,
            questions: [
              "Python 有哪些 built-in types?",
              "list, dict, set, tuple 何者是 immutable?",
              "請實作一個有參數的 Decorator",
              "請解釋 try ... except ... finally 語法",
              "請解釋 list comprehension 語法",
              "如何避免 Circular Import?",
            ]
          },
          {
            itemId: "concept",
            title: "Python運作原理 (async, multi-thread, multi-processing, garbage collection, …)",
            positionIds: null,
            questions: [
              "請解釋 Python 的 Variable Scope",
              "請解釋 async, multi-thread, multi-processing 以及三者有何不同",
              "請解釋 Python Garbage Collection 的機制",
            ]
          },
          {
            itemId: "package",
            title: "套件使用 (torch, pandas, scikit-learn, celery, FastAPI…)",
            positionIds: null,
          },
        ],
      },
      {
        groupId: "frontend",
        positionIds: ["frontend"],
        title: "前端語言能力",
        items: [
          {
            itemId: "syntax",
            title: "語法熟悉度 (data types, iteration syntaxes, function call)",
            positionIds: null,
            questions: [
              "Javascript/Typescript 有哪些 data types?",
              "有哪些宣告變數的方法? 有何區別?",
              "function 有那些呼叫方法",
              "window.onload 的用途",
              "Promise 的使用方法",
              "如何使用 array.reduce?",
            ],
          },
          {
            itemId: "framework",
            title: "框架熟悉度 (jQuery, Vue2, React, SCSS)",
            positionIds: null,
            questions: [
              "請解釋 Vue / React 的元件架構? MVC 分別代表什麼?",
              "狀態管理是什麼? 使用狀態管理有什麼好處?",
              "請解釋 useState, useRef, useMemo, useCallback, useEffect 有什麼差別?",
              "如何避免 Circular Import?",
            ],
          },
          {
            itemId: "concept",
            title: "運作原理 (async, MVC)",
            positionIds: null,
            questions: [
              "Prototype 是什麼?",
              "async 是什麼? 何時使用 async?",
              "何為 Mutable variable?",
              "請解釋 CSS 繼承的順序",
            ],
          },
          {
            itemId: "package",
            title: "套件使用 (i18n, tailwind)",
            positionIds: null,
            questions: [
              "如何實現即時多語言轉換?",
              "使用 Tailwind 控制 style 的優缺點?",
            ],
          },
          {
            itemId: "packing",
            title: "效能優化與打包技巧",
            positionIds: null,
            questions: [
              "什麼是響應式(responsive)網頁?如何實現?",
              "如何處理即時訊息? (p2p, websocket)",
              "如何優化網頁效能?",
              "如何優化存取大量資料(表格,大圖)時的使用者體驗",
              "打包包含哪些目的? 有什麼優點?",
              "如何實現 runtime configuration?",
            ],
          },
        ],
      },
      {
        groupId: "prof",
        title: "專業能力",
        positionIds: null,
        items: [
          {
            itemId: "devflow",
            title: "開發流程管理 (Git, CI/CD, Docker, test)",
            positionIds: null,
            questions: [
              "如何使用 Git 管理多角色的程式碼開發",
              "git rebase, git merge (fast forward), git cherry-pick 的效果,使用時機與原則有何不同",
              "請說明 docker container 的生命週期?",
              "如何避免 docker image 重複佔用空間?",
              "Docker container 有幾種網路的設定方式?",
              "CI/CD 如何幫助程式開發?",
              "請說明如何測試你的程式碼?",
              "請說明 Unit test 的原則",
            ],
          },
          {
            itemId: "network",
            title: "網路概念 (HTTP methods, RESTful API, CORS, attacks)",
            positionIds: ["frontend", "pythonbackend"],
            questions: [
              "為何在客戶端無法存取你開在伺服器端 127.0.0.1 的服務?",
              "HTTP methods 有哪些?",
              "URL 分成哪幾個部分?",
              "RESTful API 的設計原則?",
              "如何設定 Cache?",
              "什麼是 CORS?",
              "有哪些身分驗證的方法(JWT,cookie,oidc)? 如何使用在網頁上?",
              "何為 Single Sign-On (SSO) 有什麼好處?",
              "什麼是 SQL injection/XSS/CSRF/DDOS 攻擊? 如何避免?",
              "什麼是 forward/reverse proxy? 有什麼功能?",
            ],
          },
          {
            itemId: "database",
            title: "資料庫使用經驗及能力 (SQL, NoSQL, vector store)",
            positionIds: ["pythonbackend", "ai"],
          },
          {
            itemId: "dataproc",
            title: "處理資料能力 (data leakage, pre-/post-processing, cross validation)",
            positionIds: ["ai"],
          },
          {
            itemId: "dataexp",
            title: "處理資料經驗 (tabular, image, stream, language, audio, medical, …)",
            positionIds: ["frontend", "pythonbackend", "ai"],
          },
          {
            itemId: "aimodel",
            title: "AI 模型能力 (ensemble, training)",
            positionIds: ["ai"],
          },
          {
            itemId: "biobackground",
            title: "生物醫療背景知識",
            positionIds: null,
          },
        ],
      },
      {
        groupId: "project",
        positionIds: null,
        title: "專案實作經驗",
        items: [
          {
            itemId: "backendproj",
            title: "後端專案",
            positionIds: ["pythonbackend"],
            questions: [
              "請描述一個從頭參與的專案,最重要/有趣/有貢獻的工作是什麼",
            ],
          },
          {
            itemId: "frontendproj",
            title: "前端專案",
            positionIds: ["frontend"],
            questions: [
              "請描述一個從頭參與的專案,最重要/有趣/有貢獻的工作是什麼",
              "是否有做過 Dashboard 的專案?",
            ],
          },
          {
            itemId: "aiproj",
            title: "AI 專案",
            positionIds: ["ai"],
          },
        ]
      },
      {
        groupId: "other",
        positionIds: null,
        title: "其他",
        items: [
          {
            itemId: "positivity",
            title: "積極度",
            positionIds: null,
          },
          {
            itemId: "solv",
            title: "解決問題及組織能力",
            positionIds: null,
          },
          {
            itemId: "communication",
            title: "理解及溝通表能力",
            positionIds: null,
          },
        ],
      }
    ];
  </script>
  <body>
    <h2>面試紀錄表</h2>
    <span id="butGroup">
      <form action="">
        <button id="butEdit" hidden>啟用編輯</button>
        <button id="butSave">另存 HTML 檔</button>
        <button id="butPrint">列印</button>
      </form>
    </span>
    <h2>基本資料</h2>
    <form id="info">
      <div><label for="name">應徵者姓名</label><input id="name" type="text"></div>
      <div><label for="time">面試時間</label><input id="time" type="datetime-local"></div>
      <div>
        <label for="position">面試職位</label>
        <span>
          <select id="position" name="position" value="">
            <option value=""></option>
          </select>
          <label for="position-2">其他</label>
          <input id="position-2" type="text">
        </span>
      </div>
      <div><label for="iname">面試人員</label><input id="iname" type="text" data-fromstorage="true"></div>
    </form>
    <h2>
      檢核項目
      <form id="filter">
        <input type="checkbox" id='showUnscored' checked><label for="showUnscored">未評分項目</label>
        <input type="checkbox" id='showAllPositionUnrelated' disabled><label for="showAllPositionUnrelated">職位無關項目</label>
        <button id="showAllQuestions">展開所有題目</button>
        <button id="hideAllQuestions">收合所有題目</button>
      </form>
    </h2>
    <form id="scoring"></form>
    <form id="record">
      <h2>面試紀錄</h2>
      <textarea id="notes" rows="30"></textarea>
    </form>
  </body>
  <script>
    // utils
    function createElement (tag, attrs=null, childNodes=null) {
      const elem = document.createElement(tag);
      if (attrs != null) {
        Object.entries(attrs).forEach(([attr, value]) => {
          if (value != null) elem.setAttribute(attr, value);
        });
      }
      if (childNodes != null) {
        childNodes.forEach((node) => {
          if (node != null) elem.append(node);
        });
      }
      return elem;
    }
    function createScoringItem (id, title, positionIds, questions) {
      /*
      <div data-positionids="{positionIds.join(',')}">
        <label for="{id}">{title}</label>
        <fieldset id="{id}">
          <input type="radio" name="{id}" checked><label>?</label>
          <input type="radio" name="{id}" value="0"><label>0</label>
          <input type="radio" name="{id}" value="1"><label>1</label>
          <input type="radio" name="{id}" value="2"><label>2</label>
          <input type="radio" name="{id}" value="3"><label>3</label>
          <input type="radio" name="{id}" value="4"><label>4</label>
          <input type="radio" name="{id}" value="5"><label>5</label>
          <textarea id="{id}-comment" name="" cols="50" rows="1"></textarea>
        </fieldset>
        <div class="questions">
          <div class="question">
            <label>{question}</label>
            <selectid="{id}-question-{i}">
              <option value="" selected></option>
              <option value="0">No Experience</option>
              <option value="1">Incorrect</option>
              <option value="2">Partially Correct</option>
              <option value="3">Correct</option>
              <option value="4">Complete</option>
            </select>
          </div>
        </div>
      </div>
      */
      const elemOpts = createElement('fieldset', {id: id}, [
        createElement('input', {type: 'radio', name: id, value: '?', checked: ''}),
        createElement('label', {}, ['?'])
      ]);
      for (let i=0; i<6; i++) {
        elemOpts.append(
          createElement('input', {type: 'radio', name: id, value: i}),
          createElement('label', {}, [i])
        );
      }
      elemOpts.append(createElement('textarea', {id: `${id}-comment`, name: "", cols: 50, rows: 1}));
      const elemQuestions = createElement(
        'ol', {'class': 'questions', hidden: ''},
        questions ? (
          questions.map((question) => (
            createElement('li', {'class': 'question'}, [
              createElement('label', {}, [question]),
              createElement('select', {}, [
                createElement('option', {value: '', selected: ''}),
                ...['No Experience', 'Incorrect', 'Partially Correct', 'Correct', 'Complete'].map(
                  (opt,i)=>createElement('option', {value: i}, [opt]))
              ])
            ])
          ))
        ) : (
          [createElement('div', {'class': 'no-question'}, ['No Question'])]
        )
      );
      return createElement(
        'div',
        {'class': 'scoring-item', 'data-positionids': (positionIds??[]).join(',')},
        [createElement('label', {'for': id}, [title]), elemOpts, elemQuestions],
      );
    }
    function getPositionId () {
      return document.getElementById('position')?.value || null;
    }
    function getPositionName () {
      const pos1 = document.getElementById('position')?.value;
      if (pos1) {
        return document.querySelector(`#position > option[value=${pos1}]`).innerHTML;
      } else {
        return document.getElementById('position-2').value;
      }
    }
    function setShowQuestions (show, elems) {
      elems ??= [...document.getElementsByClassName('questions')];
      elems.forEach((elem) => {
        show ? elem.removeAttribute('hidden') : elem.setAttribute('hidden', '');
      });
    }
    function setHideAllPositionUnrelated (hide) {
      hide = hide ?? !document.getElementById('showAllPositionUnrelated').checked;
      const positionId = getPositionId();
      document.querySelectorAll("[data-positionids]").forEach((elem) => {
        const positionIds = (elem.dataset['positionids']||null)?.split(',');
        const toHide = (
          hide && positionId != null && positionIds != null
            && !positionIds.includes(positionId)
        );
        toHide ? elem.setAttribute('hidden', '') : elem.removeAttribute('hidden');
      });
    }
    function setHideAllUnscored (hide) {
      hide = hide ?? !document.getElementById('showUnscored').checked;
      const positionId = getPositionId();
      document.querySelectorAll(".scoring-item").forEach((elem) => {
        const toHide = hide && elem.querySelectorAll("[checked]")[0].value == '?';
        toHide ? elem.setAttribute('hidden', '') : elem.removeAttribute('hidden');
      });
    }
    (function () {
      // position options
      const elemPositionSelect = document.getElementById('position');
      elemPositionSelect.append(...positionOptions.map((opt) => 
        createElement('option', {'value': opt.positionId}, [opt.title])
      ));
      // scoring form
      const elemScoreForm = document.getElementById('scoring');
      scoreForm.forEach((group) => {
        elemScoreForm.append(
          createElement('h3', {'data-positionids': group.positionIds}, [group.title]),
          ...group.items.map((groupItem) => 
            createScoringItem(
              `${group.groupId}-${groupItem.itemId}`,
              groupItem.title,
              groupItem.positionIds??group.positionIds,
              groupItem.questions,
            )
          ),
        );
      });
    })();
  </script>
  <script>
    addEventListener("beforeunload", (event) => {});
    onbeforeunload = () => '';
    window.onload = () => {
      // default date
      const localStorage = window.localStorage;
      Date.prototype.toDateInputValue = (function() {
        var now = new Date();
        var offset = now.getTimezoneOffset() * 60000;
        var adjustedDate = new Date(now.getTime() - offset);
        return adjustedDate.toISOString().substring(0,16);
      }); 
      const timeElem = document.getElementById("time");
      if (!timeElem.value) {
        timeElem.value = new Date().toDateInputValue();
      }
      // default iname
      const inameElem = document.getElementById("iname")
      if (inameElem.dataset.fromstorage=="true") {
        inameElem.value = localStorage.getItem("MuenInterviewerName");
      }
      // events
      // iname change
      document.getElementById("iname").addEventListener("change", (e) => {
        const iname = e.target.value;
        localStorage.setItem("MuenInterviewerName", iname);
      });
      // pos change
      document.getElementById("position").addEventListener("change", (e) => {
        if (!!e.target.value) {
          document.getElementById("position-2").value = "";
          document.getElementById("showAllPositionUnrelated").removeAttribute('disabled');
          setHideAllPositionUnrelated();
        } else {
          document.getElementById("showAllPositionUnrelated").setAttribute('disabled', '');
          setHideAllPositionUnrelated(false);
        }
      });
      // pos2 input
      document.getElementById("position-2").addEventListener("input", (e) => {
        document.getElementById("position").value = "";
        document.getElementById("showAllPositionUnrelated").setAttribute('disabled', '');
        setHideAllPositionUnrelated(false);
      });
      // showAllPositionUnrelated
      setHideAllPositionUnrelated();
      document.getElementById("showAllPositionUnrelated").addEventListener("change", (e) => {
        setHideAllPositionUnrelated(!e.target.checked);
      });
      // show all questions
      document.getElementById('showAllQuestions').addEventListener("click", (e) => {
        setShowQuestions(true);
      });
      // hide all questions
      document.getElementById('hideAllQuestions').addEventListener("click", (e) => {
        setShowQuestions(false);
      });
      // hide unscored
      document.getElementById("showUnscored").addEventListener("change", (e) => {
        setHideAllUnscored(!e.target.checked);
      });
      // show questions
      document.querySelectorAll(".scoring-item > label").forEach((elem) => {
        elem.addEventListener("click", (e) => {
          const elemQuestion = e.target.parentElement.querySelector('.questions');
          setShowQuestions(elemQuestion.hasAttribute('hidden'), [elemQuestion]);
        })
      });
      // disable default form action
      const forms = document.getElementsByTagName("form");
      for (let form of forms) {
        form.addEventListener("submit", (e) => {e.preventDefault();}, false);
      }
      // edit button
      const butEdit = document.getElementById("butEdit");
      butEdit.addEventListener("click", (e) => {
        butEdit.setAttribute("hidden", true);
        for (let dom of document.querySelectorAll("input,textarea,select")) {
          dom.removeAttribute("disabled");
        }
      });
      // print button
      const butPrint = document.getElementById("butPrint");
      butPrint.addEventListener("click", (e) => {
        print();
      });
      // save button
      const butSave = document.getElementById("butSave");
      butSave.addEventListener("click", (e) => {
        if (!validateForm()) return;
        const name = document.getElementById("name").value;
        const time = document.getElementById("time").value;
        const posName = getPositionName();

        const match = /(\d{4})-(\d{2})-(\d{2})T(\d{2}):(\d{2})/.exec(time);
        const yyyy=match[1], mm=match[2], dd=match[3], h=match[4], m = match[5];
        const timestr = `${yyyy}${mm}${dd}_${h}${m}`
        const fname = `${posName}_${timestr}_${name}.html`;

        const html = handleFormValues();
        const htmlBlob = new Blob([html], { type: "text/html" });
        const blobUrl = URL.createObjectURL(htmlBlob);
        const anchorElement = document.createElement("a");
        anchorElement.href = blobUrl;
        anchorElement.download = fname;
        anchorElement.click();
      });
      // form
      function validateForm () {
        const name = document.getElementById("name").value;
        const iname = document.getElementById("iname").value;
        const pos1 = document.getElementById("position").value;
        const pos2 = document.getElementById("position-2").value;
        const pos = !!pos1 ? pos1 : pos2;
        if (!name) alert("應徵者姓名未填寫");
        else if (!pos) alert("面試職位未填寫");
        else if (!iname) alert("面試人員未填寫");
        else {
          return true;
        }
        return false;
      }
      function handleFormValues () {
        const butEdit = document.getElementById("butEdit");
        butEdit.removeAttribute("hidden");

        document.getElementById("iname").setAttribute("data-fromstorage", "false");
        for (let dom of document.querySelectorAll("input[type=text]")) {
          dom.setAttribute("value", dom.value)
          dom.setAttribute("disabled", true);
        }
        for (let dom of document.querySelectorAll("input[type=radio]")) {
          if (dom.checked) {
            dom.setAttribute("checked", "true");
          } else {
            dom.removeAttribute("checked");
          }
          dom.setAttribute("disabled", true);
        }
        for (let dom of document.querySelectorAll("select")) {
          dom.setAttribute("value", dom.value)
          dom.setAttribute("disabled", true);
          for (let opt of dom.children) {
            if (opt.selected) {
              opt.setAttribute("selected", "true")
            } else {
              opt.removeAttribute("selected")
            }
          }
        }
        for (let dom of document.querySelectorAll("input[type=datetime-local]")) {
          dom.setAttribute("value", dom.value)
          dom.setAttribute("disabled", true);
        }
        for (let dom of document.getElementsByTagName("textarea")) {
          dom.innerHTML = dom.value;
          dom.setAttribute("disabled", true);
        }
        const html = document.getElementsByTagName("html")[0].innerHTML;
        return html;
      }
    }
  </script>
  <style>
  label {
    margin-right: 5px;
  }
  input[type=radio] {
    margin: 0 3px;
  }
  form#filter {
    font-size: initial;
    font-weight: normal;
    display: inline-flex;
    align-items: center;
  }
  form#filter button {
    margin-right: 5px;
  }
  form#scoring {
    width: 80%;
    min-width: 600px;
    margin-bottom: 5px;
  }
  form#scoring .scoring-item {
    display: flex;
    justify-content: space-between;
    margin-bottom: 5px;
    flex-wrap: wrap;
  }
  form#scoring .scoring-item > label {
    cursor: pointer;
    flex: 1;
    user-select: none;
  }
  form#scoring fieldset {
    display: flex;
    align-items: center;
    border: none;
  }
  form#scoring .questions {
    flex-basis: 100%;
    background: lightgray;
    padding: 10px 0 10px 40px;
  }
  textarea#notes {
    width: 80vw;
  }
  #butGroup {
    display: block;
    position: absolute;
    right: 50px;
    top: 50px;
  }
  [hidden] {
    display: none !important;
  }
  </style>
</html>
